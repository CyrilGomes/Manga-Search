<!DOCTYPE html>
<!--suppress HtmlFormInputWithoutLabel, JSUnresolvedVariable -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" rel="stylesheet">
    <link href="styles/index.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Manga search</title>
</head>

<body>
<main>
    <div style="display: flex; justify-content: center">
        <iframe allowFullScreen class="giphy-embed" height="45"
                src="https://giphy.com/embed/IcJ6n6VJNjRNS"
                width="45"></iframe>
        <h1 style="margin-bottom: 0; text-align-all: center">Manga <span style="color:#AC0E35;">Search</span></h1>
        <iframe allowFullScreen class="giphy-embed" height="45"
                src="https://giphy.com/embed/IcJ6n6VJNjRNS"
                width="45"></iframe>
    </div>
    <div class="search">
        <div class="form-item" style="display: flex;">
            <input autocomplete="on" class="form-control" id="name" list="titles"
                   placeholder="Chercher un manga par titre"
                   type="search">
            <datalist id="titles"></datalist>
        </div>
        <div class="form-item">
            <button id="bt-recherche-avancee" style="all: unset; cursor: pointer">
                <span>Recherche avancée</span>
                <img alt="image d'une flèche allant vers le bas"
                     class="rotating-icon"
                     id="i-recherche-avancee"
                     src="Arrowhead-Down-256.png"
                     style="height: 20px; width: 20px"
                />
            </button>
            <div id="champs-recherche-avancee">
                <div class="form-item">
                    <input class="form-control" id="author" placeholder="Auteur du manga" type="text">
                </div>
                <div class="form-item" id="year-container">
                </div>
                <div class="form-item">
                    <textarea class="form-control" id="filter" placeholder="Filtres (1 par ligne)"
                              type="text"></textarea>
                </div>
            </div>
        </div>
        <div class="form-item">
            <button id="valider">
                <div>Rechercher</div>
                <div><img height="20px" src="Magnifying-Glass-256.png" width="20px"/></div>
            </button>
        </div>
    </div>
</main>
<script type="text/javascript">
    $(document).ready(function () {
        let newDiv = document.createElement('div');
        let currYear = new Date().getFullYear();
        let selectHTML = "<select class='form-select' id='year'>";
        for (let i = 1970; i < currYear; i = i + 1) {
            selectHTML += "<option value='" + i + "'>" + i + "</option>";
        }
        selectHTML += "<option value='" + currYear + "' selected>" + currYear + "</option>";
        selectHTML += "</select>";
        newDiv.innerHTML = selectHTML;
        document.getElementById("year-container").appendChild(newDiv);


        let btSearch = $('#valider');
        let btAdvancedSearch = $('#bt-recherche-avancee');
        let inputTitle = $('#name');
        let rechercheAvancee = false;

        function sendSearch() {
            let name = $('#name');
            let author = $('#author');
            let year = $('#year');
            let filter = $('#filter');
            let filterText = filter.val().replace('\n', ';');
            let queryText = "search.html?";
            if (!(name.val() === "")) queryText += "search=" + name.val() + "&";
            if (rechercheAvancee) {
                if (!(author.val() === "")) queryText += "author=" + author.val() + "&";
                if (!(year.val() === "")) queryText += "year=" + new Date(year.val()).getFullYear() + "&";
                if (!(filterText === "")) queryText += "filter=" + filterText + "&";
            }
            window.location.assign(queryText.substr(0, queryText.length - 1));
        }

        btSearch.click(function () {
            sendSearch();
        });

        inputTitle.on('keydown', function (e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                sendSearch();
            }
        });

        btAdvancedSearch.click(function () {
            let iconeRecherche = $('#i-recherche-avancee');
            if (rechercheAvancee) {
                iconeRecherche.toggleClass('active', false);
                $('#champs-recherche-avancee').toggleClass('active', false);
                rechercheAvancee = false;
            } else {
                iconeRecherche.toggleClass('active', true);
                $('#champs-recherche-avancee').toggleClass('active', true);
                rechercheAvancee = true;
            }
        })

        inputTitle.on('input', function () {
            let inputText = $(this).val().replaceAll(" ", "_");
            let contenu_requete = "SELECT DISTINCT ?manga WHERE {?manga dbo:type dbr:Manga. FILTER(regex(?manga, \"" + inputText + "\",\"i\"))} LIMIT 20";
            let url = "https://dbpedia.org/sparql?query=" + encodeURIComponent(contenu_requete) + "&format=json";
            $('#titles')[0].innerHTML = "";
            $.ajax({
                dataType: "jsonp",
                url: url,
                success: function (data) {
                    data.results.bindings.forEach(manga => {
                        console.log(manga.manga.value);
                        let filteredTitle = manga.manga.value.replaceAll('_', ' ').replace("http://dbpedia.org/resource/", "");
                        $('#titles').append(`<option value="${filteredTitle}"/>`);
                    });
                }
            });
        })
    });
</script>
<script crossorigin="anonymous"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>