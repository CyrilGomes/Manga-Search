<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="styles/search.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="styles/search.css">
    <title>Title</title>
</head>
<body>
    <main>
        <h1>Manga <span style="color:#AC0E35;">Search</span> </h1>
        <div class="form-item">
            <input class="form-control" id="name" placeholder="Chercher un manga par titre" type="text">
        </div>
        <div class="form-item">
            <button id="bt-recherche-avancee" style="all: unset; cursor: pointer">
                <span>Recherche avancée</span>
                <img alt="image d'une flèche allant vers le bas"
                     class="rotating-icon"
                     id="i-recherche-avancee"
                     src="Arrowhead-Down-256.png"
                     style="height: 20px; width: 20px"
                />
            </button>
            <div id="champs-recherche-avancee">
                <div class="form-item">
                    <input class="form-control" id="author" placeholder="Auteur du manga" type="text">
                </div>
                <div class="form-item">
                    <input class="form-control" id="year" placeholder="Année de parution" type="date">
                </div>
                <div class="form-item">
                    <textarea class="form-control" id="filter" placeholder="Filtres (1 par ligne)"
                              type="text"></textarea>
                </div>
            </div>
        </div>
        <div class="form-item">
            <button onclick="search()">Rechercher</button>
        </div>
    </main>
</script>
<table class="tableResults" id="displayResults">
    </table>
</body>
<script>
    let queryParams = new URLSearchParams(window.location.search);
    let input = queryParams.get("search")
    if (input != null){
        $(document).ready(searchInit)
    }
    function searchInit() {
        var author = queryParams.get("author")
        var year = queryParams.get("year")
        var filter = queryParams.get("filter")
        mainSearch(input, author, year, filter)
    }
    function search() {
        var input = $('#name');
        var author = $('#author');
        var year = $('#year');
        var filter = $('#filter');
        console.log(input.val());
        mainSearch(input.val(), author.val(), year.val(), filter.val());
    }
    function mainSearch(uInput, uAuthor, uYear, uFilter) {
        $("#displayResults tr").remove();
        $("#displayResults th").remove();
        $("#displayResults thead").remove();
        var input = uInput.replace(" ", "_");
        var author = uAuthor;
        if (author != null) {
            author = author.replace(" ", "_");
        }
        var year = uYear;
        var filter = uFilter;
        if (filter != null) {
            filter = filter.replace(" ", "_");
        }


        /*document.getElementById('search-terms').value = input;*/
        var urlSearch = "http://dbpedia.org/sparql";
        var queryArray = ["SELECT DISTINCT ?manga WHERE { ?manga dbo:type dbr:Manga ;",
            "dbo:firstPublicationDate ?startDate "]
        if (author !== "") {
            queryArray.push("; dbo:author ?author");
        }
        queryArray.push(". FILTER( regex(?manga, \"" + input + "\",\"i\")");
        if (author !== "") {
            queryArray.push("&& regex(?author, \"" + author + "\",\"i\")");
        }
        if (year !== "") {
            queryArray.push("&& regex(?startDate, \"" + year + "\", \"i\")");
        }
        if (filter !== "") {
            queryArray.push("&& regex(?startDate, \"^((?!" + filter + ").)*$\", \"i\")");
        }
        queryArray.push(") }");
        var query = queryArray.join(" ");

        var queryUrl = urlSearch + "?query=" + encodeURIComponent(query) + "&format=json";
        console.log(queryUrl);
        $.ajax({
            dataType: "jsonp",
            url: queryUrl,
            success: function (data) {
                var table = $("#displayResults");
                console.log(data);
                // get the sparql variables from the 'head' of the data.
                var headerVars = data.head.vars;

                // using the vars, make some table headers and add them to the table;
                var trHeaders = getTableHeaders(headerVars);
                table.append(trHeaders);

                // grab the actual results from the data.
                var bindings = data.results.bindings;

                // for each result, make a table row and add it to the table.
                for (rowIdx in bindings) {
                    table.append(getTableRow(headerVars, bindings[rowIdx]));
                }
            }
        });
    }
    function getTableRow(headerVars, rowData) {
        var tr = $("<tr></tr>");

        for (var i in headerVars) {
            tr.append(getTableCell(headerVars[i], rowData));
        }

        return tr;
    }
    function getTableCell(fieldName, rowData) {
        var td = $("<td></td>");
        var fieldData = rowData[fieldName];
        var arrayData = fieldData["value"].split("http://dbpedia.org/resource/")
        var tailleArray = arrayData.length
        var data = arrayData[tailleArray-1]


        //alert("fieldName = ["+fieldName +"] rowData[fieldName][value] = ["+rowData[fieldName]["value"] + "]");
        if (tailleArray === 1){
            td.html(fieldData["value"]);
        }
        else{
            td.html("<a href="+fieldData["value"]+">"+data.replace("_"," ")+"</a>");
        }
        return td;
    }
    function getTableHeaders(headerVars) {
        var trHeaders = $("<thead><tr></tr></thead>");
        for (var i in headerVars) {
            trHeaders.append($("<th>" + headerVars[i] + "</th>>"));
        }
        return trHeaders;
    }
    
    var MD5 = function(d){var r = M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}

    async function getWikipediaThumbnail(resourceName) {
      var url = "https://en.wikipedia.org/w/api.php?action=query&prop=images&format=json&titles=" +resourceName;

      var data = await $.ajax({
        dataType: "jsonp",
        url: url,
      });

      var item = data["query"]["pages"][Object.keys(data["query"]["pages"])[0]];

      var wikiImages = [
        "File:commons-logo.svg",
        "Wiki",
        "Edit-clear",
        "File:Symbol category class.svg",
        "File:Wikipe-tan face.svg",
        "File:Question book-new.svg",
      ];

      let isWikiImage = false;
      item["images"].forEach((element) => {
        console.log(element);
        wikiImages.forEach((wikiIm) => {
          if (element["title"].includes(wikiIm)) {
            isWikiImage = true;
          }
        });
        if (!isWikiImage) {
          imageName = element["title"];
        }
      });

      imageNameClean = imageName.substr(5).replace(/ /g, "_");
      md5Hashed = MD5(imageNameClean);
      imageUrl =
        "https://upload.wikimedia.org/wikipedia/en/" +
        md5Hashed[0] +
        "/" +
        md5Hashed.substr(0, 2) +
        "/" +
        imageNameClean;
      console.log(imageUrl);

      return (
        "<img style='' src='" +
        imageUrl +
        "'/>"
      );
    }

</script>
</html>
  

</html>
