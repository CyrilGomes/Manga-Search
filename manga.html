<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="styles/manga.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Manga search</title>
  </head>

  <body>
    <h1 id="name"></h1>

    <div>
      <p id="description"></p>
    </div>

    <div>
      Author:
      <p id="author"></p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Number of volumes</th>
          <th>Date of first volume</th>
          <th>Publisher</th>
          <th>Magazine</th>
          <th>Genres</th>
        </tr>
      </thead>
      <tbody>
        <td id="numberOfVolumes"></td>
        <td id="startDate"></td>
        <td id="publisher"></td>
        <td id="magazine"></td>
        <td id="genres"></td>
      </tbody>
    </table>
  </body>

  <script>
    $(document).ready(() => {
      const manga = window.location.search.split('=')[1];
      const urlSearch = 'http://dbpedia.org/sparql';

      const query = `SELECT ?name ?description ?startDate ?author ?publisher ?magazine ?numberOfVolumes GROUP_CONCAT(DISTINCT ?genre; separator="|") as ?genres WHERE {
    ?uri rdfs:label ?name ;
    rdfs:comment ?description;
    dbo:firstPublicationDate ?startDate ;
    dbo:author ?author;
    dbo:publisher ?publisher;
    dbp:magazine ?magazine;
    dbp:volumes ?numberOfVolumes;
    dbp:genre ?genre.
    FILTER (?uri = dbr:${manga}
    && lang(?name)="en"
    && lang(?description)="en"
    )
    }`;

      const queryUrl =
        urlSearch + '?query=' + encodeURIComponent(query) + '&format=json';
      console.log(queryUrl);

      $.ajax({
        dataType: 'jsonp',
        url: queryUrl,
        success: (data) => {
          console.log(data);

          const name = data.results.bindings[0].name.value;
          const description = data.results.bindings[0].description.value;
          const startDate = data.results.bindings[0].startDate.value;
          const author = data.results.bindings[0].author.value;
          const publisher = data.results.bindings[0].publisher.value;
          const magazine = data.results.bindings[0].magazine.value;
          const numberOfVolumes =
            data.results.bindings[0].numberOfVolumes.value;
          const genres = data.results.bindings[0].genres.value.split('|');

          document.title = name;
          $('#name').text(name);
          $('#description').text(description);
          $('#author').text(formatUri(author));
          $('#numberOfVolumes').text(numberOfVolumes);
          $('#startDate').text(startDate);
          $('#publisher').text(formatUri(publisher));
          $('#magazine').text(formatUri(magazine));

          console.log('genres', genres);

          let genreHtml = '<ul>';
          for (const genre of genres) {
            genreHtml += '<li>';
            genreHtml += formatUri(genre);
            genreHtml += '</li>';
          }
          genreHtml += '</ul>';
          $('#genres').html(genreHtml);
        },
      });
    });

    const formatUri = (uri) => {
      return uri.split('resource/')[1].replaceAll('_', ' ');
    };
  </script>
</html>
