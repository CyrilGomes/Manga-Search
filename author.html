<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="styles/manga.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>Manga search</title>
  </head>

  <body>
    <h1 id="name"></h1>

    <div>
      <p id="description"></p>
    </div>

    <div>
      <p>date and place of birth :<br>
        <span id="birthDate"></span> -
        <span id="birthPlace"></span>
      </p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Date of debut</th>
          <th>Notable Works</th>
          <th>awards</th>
        </tr>
      </thead>
      <tbody>
        <td id="debut"></td>
        <td id="works"></td>
        <td id="awards"></td>
      </tbody>
    </table>
  </body>

  <script>
    $(document).ready(() => {
      const author = window.location.search.split('=')[1];
      const urlSearch = 'http://dbpedia.org/sparql';

      const query = `SELECT DISTINCT ?name 
                  (SAMPLE(?description) as ?descriptionAuteur)  
                  (SAMPLE(?birthDate) as ?birthDateAuteur) 
                  (SAMPLE(?birthPlace) as ?birthPlaceAuteur) 
                  (SAMPLE(?debut) as ?debutAuteur)  
                  (SAMPLE(?uri) as ?uriAuteur)  
                  GROUP_CONCAT(DISTINCT ?work; separator="|") as ?works  
                  GROUP_CONCAT(DISTINCT ?award; separator="|") as ?awards WHERE { 
                    ?uri  rdfs:label ?name; 
                    a foaf:Person; 
                    rdfs:comment ?description; 
                    dbp:birthDate ?birthDate; 
                    dbp:birthPlace ?birthPlace. 
                    {?uri dbp:notableWorks ?work.} 
                    UNION 
                    {?uri dbp:notableworks ?work.} 
                    OPTIONAL{?uri dbp:yearsActive ?debut .} 
                    OPTIONAL{?uri dbp:awards ?award.} 
                    FILTER(?uri = dbr:${author}
                      && lang(?description)="en" 
                      && lang(?name)="en" 
                      && lang(?work)="en" 
                    ) 
                  }  `;

      const queryUrl =
        urlSearch + '?query=' + encodeURIComponent(query) + '&format=json';
      console.log(queryUrl);

      $.ajax({
        dataType: 'jsonp',
        url: queryUrl,
        success: (data) => {
          console.log(data);

          const name = data.results.bindings[0].name.value;
          const description = data.results.bindings[0].descriptionAuteur.value;
          const dateBirth = data.results.bindings[0].birthDateAuteur.value;
          const placeBirth = data.results.bindings[0].birthPlaceAuteur.value;
          const works = data.results.bindings[0].works.value.split('|');
          let debut = "unknown";
          let awards = "no awards";

          let worksHtml = '<ul>';
          for (const work of works) {
            worksHtml += '<li>';
            worksHtml += "<a href='manga.html?manga="+work.replaceAll(' ','_')+"'>"+work+"</a>";
            worksHtml += '</li>';
          }
          worksHtml += '</ul>';

          if( data.results.bindings[0].debutAuteur != undefined){
            debut = data.results.bindings[0].debutAuteur.value;
          }

          let awardsHtml = awards;
          if(data.results.bindings[0].awards != undefined){
            awards = data.results.bindings[0].awards.value.split("|");
            awardsHtml = '<ul>';
            for (const award of awards) {
              awardsHtml += '<li>';
              awardsHtml += formatUri(award);
              awardsHtml += '</li>';
            }
            awardsHtml += '</ul>';
          }

          document.title = name;
          $('#name').text(name);
          $('#description').text(description);
          $('#birthDate').text(dateBirth);
          $('#birthPlace').text(placeBirth);
          $('#debut').text(debut);

          $('#works').html(worksHtml);
          
          $('#awards').html(awardsHtml);
        },
      });
    });

    const formatUri = (uri) => {
      return uri.split('resource/')[1].replaceAll('_', ' ');
    };
  </script>
</html>
